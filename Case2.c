#include "common.h"

// 2. 회원 등록 함수
void case2(FILE *fp, Member_t *id, int *maxnum)   // 2. 회원 등록 실행
{
	system("cls");
	case2UI();
	inputNewMember(fp, id, maxnum); // 회원등록이 완료되면 +1, 취소되면 0
}

int findMaxStudentNum(Member_t *id, int maxnum)   // 현재 저장된 학생들 중 가장 큰 학번 검색
{
	int i, maxstudentnum;
	for (i = 2; i <= maxnum; i++){
		if (id[i - 1].Studentnum < id[i].Studentnum)
			maxstudentnum = id[i].Studentnum;
	}
	return maxstudentnum;
}
void inputNewMember(FILE *fp, Member_t *id, int *maxnum)   // 새로운 회원 정보를 입력
{
	int i, j, valid = -1, repeatcheck = -1, count = 0;
	int maxstudentnum = findMaxStudentNum(id, *maxnum);
	maxstudentnum++; // 학생 학번 중 가장 큰 학번을 찾은 후 +1

	id[*maxnum].Studentnum = maxstudentnum;

	gotoxy(20, 4); printf("%d", maxstudentnum);
	gotoxy(63, 4); printf("(자동생성)");

	while (valid)
	{
		if (count == 0){
			textColor(10);
			gotoxy(17, 6); printf("┌─────────────────────┐");
			gotoxy(17, 7); printf("│"); gotoxy(61, 7); printf("│");
			gotoxy(17, 8); printf("└─────────────────────┘");
			textColor(7);
		}
		gotoxy(20, 7);
		gets(id[*maxnum].Name);
		valid = validName(id[*maxnum].Name, 1);
		count++;
	}
	gotoxy(17, 6); printf("┌─────────────────────┐");
	gotoxy(17, 7); printf("│"); gotoxy(61, 7); printf("│");
	gotoxy(17, 8); printf("└─────────────────────┘");
	validNameErrorOff(); valid = -1; count = 0;

	while (valid){
		if (count == 0){
			textColor(10);
			gotoxy(17, 9); printf("┌─────────────────────┐");
			gotoxy(17, 10); printf("│"); gotoxy(61, 10); printf("│");
			gotoxy(17, 11); printf("└─────────────────────┘");
			textColor(7);
		}
		gotoxy(20, 10);
		gets(id[*maxnum].Address);
		valid = validAddress(id[*maxnum].Address, 0);
		count++;
	}
	gotoxy(17, 9); printf("┌─────────────────────┐");
	gotoxy(17, 10); printf("│"); gotoxy(61, 10); printf("│");
	gotoxy(17, 11); printf("└─────────────────────┘");
	validAddressErrorOff(); valid = -1; count = 0;

	while (repeatcheck){
		for (i = 0, j = 0; i < 13;){
			if (count == 0){
				textColor(10);
				gotoxy(17, 12); printf("┌─────────────────────┐");
				gotoxy(17, 13); printf("│"); gotoxy(61, 13); printf("│");
				gotoxy(17, 14); printf("└─────────────────────┘");
				textColor(7);
			}
			if (i == 3 || i == 8){
				id[*maxnum].Cellphone[i] = '-'; i++; j += 2;
			}
			else {
				gotoxy(22 + i + j, 13);
				id[*maxnum].Cellphone[i] = getche();
				if (i != 0 && id[*maxnum].Cellphone[i] == 8){
					if (i == 4 || i == 9){
						printf("  \b\b");
						i -= 2;
						j -= 2;
						gotoxy(22 + i + j, 13);
						printf("  \b\b");
					}
					else{
						i--;
						printf("  \b\b");
					}
				}
				else{
					valid = validCellphone(id[*maxnum].Cellphone[i]);
					if (valid == 0) i++;
					else {
						validCellphoneErrorOn();
						count++;
					}
				}
			}
		}
		id[*maxnum].Cellphone[i] = '\0';
		validCellphoneErrorOff(); valid = -1;
		repeatcheck = repeatCellphone(id, id[*maxnum].Cellphone, *maxnum);
		if (repeatcheck == -1) {
			repeatCellphoneErrorOn(0);
			count++;
		}
	}
	gotoxy(17, 12); printf("┌─────────────────────┐");
	gotoxy(17, 13); printf("│"); gotoxy(61, 13); printf("│");
	gotoxy(17, 14); printf("└─────────────────────┘");
	repeatCellphoneErrorOff();
	valid = inputMemberSave();
	cursorOff();
	if (valid == 0){
		id[*maxnum].Studentnum = 0;
		id[*maxnum].Name;
		id[*maxnum].Address;
		id[*maxnum].Cellphone;
		j = 0;
		textColor(16 * 10);
		gotoxy(0, 26); printf("                 < 회원 등록이 취소 되었습니다 >   아무키나 누르세요       ");
		textColor(7);
		gotoxy(74, 26); getche(); fflush(stdin);
	}
	else {
		id[*maxnum - 1].next = &id[*maxnum];
		id[*maxnum].prev = &id[*maxnum - 1];
		id[*maxnum].next = NULL;
		j = 1;
		closeCase2();
	}
	cursorOn();
	id[*maxnum + 1].Studentnum = 0;
	*maxnum += j;
}
int validName(char *str, int key)   // 이름에 한글 외 입력 금지
{
	int i = 0, len = strlen(str), check = 0;
	if (str[0] >= 0 && str[0] <128){
		validNameErrorOn(key); check = -1;
	}
	else if (len == 0 || str[0] == ' ') {
		validNameErrorOn(key); check = -1;
	}
	else if (len > 8) {
		validNameErrorOn(key); check = -1;
	}
	else {
		while (i < (len - 1)){
			if (str[i] <= -56 && str[i] >= -80){
				if (str[i] < 0)	{
					if (str[i + 1] <= -2 && str[i + 1] >= -95){
						i += 2;
					}
					else { validNameErrorOn(key); check = -1; break; }
				}
				else { validNameErrorOn(key); check = -1; break; }
			}
			else { validNameErrorOn(key); check = -1; break; }
		}
	}
	return check;
}
void validNameErrorOn(int key)   // 잘못된 이름 입력시 에러 메세지 On
{
	textColor(12 * 16);
	gotoxy(0, 28); printf("       Warning: 이름은 띄어쓰기 없이 4자이내로 한글만 입력하세요           ");
	textColor(7);
	if (key == 1){
		gotoxy(19, 7); printf("                                          ");
		gotoxy(19, 10); printf("                                          ");
		gotoxy(19, 13); printf(" (     -      -      )                    ");
		case2UI();
		textColor(12);
		gotoxy(17, 6); printf("┌─────────────────────┐");
		gotoxy(17, 7); printf("│"); gotoxy(61, 7); printf("│");
		gotoxy(17, 8); printf("└─────────────────────┘");
		textColor(7);
	}
}
void validNameErrorOff(void)   // 잘못된 이름 입력시 에러 메세지 Off
{
	gotoxy(0, 28); lineClear();
	gotoxy(63, 7); printf("(입력완료)");
}
int validAddress(char *str, int menu)   // 입력된 주소 valid 유무 확인
{
	int i = 0, len = strlen(str), check = 0;
	if (len > 40) {
		validAddressErrorOn(menu); check = -1;
	}
	return check;
}
void validAddressErrorOn(int menu)   // 잘못된 이름 입력시 에러 메세지 On
{
	textColor(12 * 16);
	gotoxy(0, 28); printf("           Warning: 주소는 띄어쓰기 포함 20자이내로 입력하세요             ");
	textColor(7);
	if (menu == 0){
		gotoxy(19, 10); printf("                                         ");
		gotoxy(19, 13); printf(" (     -      -      )                    │");
		case2UI();
		textColor(12);
		gotoxy(17, 9); printf("┌─────────────────────┐");
		gotoxy(17, 10); printf("│"); gotoxy(61, 10); printf("│");
		gotoxy(17, 11); printf("└─────────────────────┘");
		textColor(7);
		gotoxy(63, 7); printf("(입력완료)");
	}
}
void validAddressErrorOff(void)   // 잘못된 주소 입력시 에러 메세지 Off
{
	gotoxy(0, 28); lineClear();
	gotoxy(63, 10); printf("(입력완료)");
}
int validCellphone(char a)   // 이름에 한글 외 입력 금지
{
	int check = 0;
	if (a < 48 || a > 57)    // 숫자 아스키코드=48~57 외에 입력 시 Error
		check = -1;
	return check;
}
int repeatCellphone(Member_t *id, char *str, int maxnum)
{
	for (int i = 1; i < maxnum; i++){
		if (strcmp(id[i].Cellphone, id[maxnum].Cellphone) == 0)  // 전화 번호가 같다면 -1을 반환
			return -1;
	}
	return 0;
}
void validCellphoneErrorOn(void)   // 잘못된 전화번호 입력시 에러 메세지 On
{
	textColor(12 * 16);
	gotoxy(0, 28); printf("               Warning: 전화번호는 11자 이내 숫자만 입력하세요             ");
	textColor(7);
	textColor(12);
	gotoxy(17, 12); printf("┌─────────────────────┐");
	gotoxy(17, 13); printf("│"); gotoxy(61, 13); printf("│");
	gotoxy(17, 14); printf("└─────────────────────┘");
	textColor(7);
}
void validCellphoneErrorOff(void)   // 잘못된 주소 입력시 에러 메세지 Off
{
	gotoxy(0, 28); lineClear();
}
void repeatCellphoneErrorOn(int menu)   // 잘못된 전화번호 입력시 에러 메세지 On
{
	textColor(12 * 16);
	gotoxy(0, 28); printf("         Warning: 기존 회원과 동일한 전화번호입니다! 다시 입력하세요       ");
	textColor(7);
	if (menu == 0){
		textColor(12);
		gotoxy(17, 12); printf("┌─────────────────────┐");
		gotoxy(17, 13); printf("│"); gotoxy(61, 13); printf("│");
		gotoxy(17, 14); printf("└─────────────────────┘");
		textColor(7);
		gotoxy(19, 13); printf(" (     -      -      )                    ");
	}
}
void repeatCellphoneErrorOff(void)   // 잘못된 전화번호 입력시 에러 메세지 Off
{
	gotoxy(0, 28); lineClear();
	gotoxy(63, 13); printf("(입력완료)");
}
void closeCase2(void)
{
	int inputkey;
	textColor(16 * 10);
	gotoxy(0, 26); printf("                 < 회원 등록이 완료 되었습니다 >   아무키나 누르세요       ");
	textColor(7);
	gotoxy(74, 26); inputkey = getche();
}
int inputMemberSave(void)   // 입력한 회원의 정보 저장 유무 확인
{
	int key = -1, check = -1;
	textColor(16 * 14);
	gotoxy(0, 26); printf("                < 회원 등록 완료 > 저장하시겠습니까? (Y/N) 【 】           ");
	textColor(7);
	while (check != 1 || check != 0){
		gotoxy(61, 26); key = getche();
		if (key == 89 || key == 121){
			check = 1; break;
		}
		else if (key == 78 || key == 110){
			check = 0; break;
		}
		else{
			textColor(12 * 16);
			gotoxy(0, 28); printf("                  Warning: Y(예) 혹은 N(아니요) 키를 입력하세요            ");
			textColor(16 * 14);
			gotoxy(0, 26); printf("                < 회원 등록 완료 > 저장하시겠습니까? (Y/N) 【 】           ");
			textColor(7);
		}
	}
	gotoxy(0, 28); lineClear();
	return check;
}

void case2UI(void)   // 회원등록 UI 출력
{
	gotoxy(0, 0);
	textColor(16 * 14);
	printf("                                < 회원 등록 >                              ");
	textColor(7);
	printf("\n\n                 ┌─────────────────────┐            ");
	gotoxy(11, 4); printf("학번 : ");
	gotoxy(17, 4); printf("│"); gotoxy(61, 4); printf("│");
	printf("\n                 └─────────────────────┘            ");
	printf("                 ┌─────────────────────┐            ");
	printf("   ①      이름 :│");
	gotoxy(61, 7); printf("│            ");
	printf("                 └─────────────────────┘            ");
	printf("                 ┌─────────────────────┐            ");
	printf("   ②      주소 :│");
	gotoxy(61, 10); printf("│            ");
	printf("                 └─────────────────────┘            ");
	printf("                 ┌─────────────────────┐            ");
	printf("   ③  전화번호 :│ (     -      -      )                    │            ");
	printf("                 └─────────────────────┘            ");
	lineClear();
	lineClear();
	textColor(14);
	printf("              ┌───────< 입력시 주의 사항 >───────┐         ");
	printf("              │                                                │         ");
	printf("              │  "); textColor(15);
	printf("1. 학번: 자동으로 생성"); textColor(14);
	printf("                        │         ");
	printf("              │  "); textColor(15);
	printf("2. 이름: 띄어쓰기 없이 4자이내 한글만 입력"); textColor(14);
	printf("    │         ");
	printf("              │  "); textColor(15);
	printf("3. 주소: 띄어쓰기 포함 20자 이내 입력"); textColor(14);
	printf("         │         ");
	printf("              │  "); textColor(15);
	printf("4. 전화번호: 11자리 이내 숫자 입력"); textColor(14);
	printf("            │         ");
	printf("              │  "); textColor(12);
	printf("5. 프로그램 종료 전 TXT파일 저장 필요"); textColor(14);
	printf("         │         ");
	printf("              └────────────────────────┘         ");
	textColor(7);
}